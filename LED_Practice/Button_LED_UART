#include "stm32c0xx_hal.h"
#include <string.h> // strlen 함수를 쓰기 위해 추가

UART_HandleTypeDef huart1; // UART 비서(핸들) 선언

// UART 초기화 함수: 통신 속도와 규칙을 정한다.
void MX_USART2_UART_Init(void){
  huart1.Instance = USART2;
  huart1.Init.BaudRate = 115200; // 속도를 115200으로 약속
  huart1.Init.WordLength = UART_WORDLENGTH_8B;
  huart1.Init.StopBits = UART_STOPBITS_1;
  huart1.Init.Parity = UART_PARITY_NONE;
  huart1.Init.Mode = UART_MODE_TX_RX;
  huart1.Init.HwFlowCtl = UART_HWCONTROL_NONE;
  HAL_UART_Init(&huart1);
}

int main(void){
  HAL_Init();

// 클럭 켜기
  __HAL_RCC_GPIOA_CLK_ENABLE();
  __HAL_RCC_USART2_CLK_ENABLE();

// LED 설정 (PA5)
  GPIO_InitTypeDef led_struct = {0};
  led_struct.Pin = GPIO_PIN_5;
  led_struct.Mode = GPIO_MODE_OUTPUT_PP;
  HAL_GPIO_Init(GPIOA, &led_struct);

// 버튼 설정 (PA12)
  GPIO_InitTypeDef btn_struct = {0};
  btn_struct.Pin = GPIO_PIN_12;
  btn_struct.Mode = GPIO_MODE_INPUT;
  btn_struct.Pull = GPIO_PULLUP;
  HAL_GPIO_Init(GPIOA, &btn_struct);

// UART용 핀 설정 추가
  GPIO_InitTypeDef uart_gpio = {0};
  uart_gpio.Pin = GPIO_PIN_2 | GPIO_PIN_3;
  uart_gpio.Mode = GPIO_MODE_AF_PP; // Alternate function
  uart_gpio.Pull = GPIO_NOPULL;
  uart_gpio.Speed = GPIO_SPEED_FREQ_LOW;
  uart_gpio.Alternate = GPIO_AF1_USART2;
  HAL_GPIO_Init(GPIOA, &uart_gpio);

  // UART 초기화 실행
  MX_USART2_UART_Init();

  char *msg = "Button Pressed!\r\n";

  while(1){
    // 버튼을 누르면 (RESET)
    if(HAL_GPIO_ReadPin(GPIOA, GPIO_PIN_12) == GPIO_PIN_RESET){
      HAL_GPIO_WritePin(GPIOA, GPIO_PIN_5, GPIO_PIN_SET);

      // PC 화면으로 전송
      HAL_UART_Transmit(&huart1, (uint8_t*)msg, strlen(msg), 100);

      // 메세지가 너무 많이 출력되지 않게 약간의 대기시간을 준다.
      HAL_Delay(200);
    } else{
      HAL_GPIO_WritePin(GPIOA, GPIO_PIN_5, GPIO_PIN_RESET);
    }
  }
}
